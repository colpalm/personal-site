{{ $chartID := default (printf "chart-%d" (now.UnixNano)) (.Get "id") }}
{{ $chartType := default "bar" (.Get "type") }}
{{ $height := default "400" (.Get "height") }}
{{ $width := default "100%" (.Get "width") }}
{{ $useDefaultColors := default "true" (.Get "useDefaultColors") | lower }}
{{ $data := .Inner }}

<div class="chart-container" style="height: {{ $height }}px; width: {{ $width }};">
    <canvas id="{{ $chartID }}"></canvas>
</div>

<script>
    // Register this chart to be initialized when ThemeHelper is ready
    window.chartsToInitialize = window.chartsToInitialize || [];
    window.chartsToInitialize.push({
        id: '{{ $chartID }}',
        type: '{{ $chartType }}',
        data: {{ $data | safeJS }},
    useDefaultColors: {{ $useDefaultColors }},
    width: '{{ $width }}',
        height: {{ $height }}
    });

    // If ThemeHelper is already available, initialize all pending charts
    if (window.ThemeHelper && window.chartsToInitialize.length > 0) {
        window.initializePendingCharts();
    }

    // Define the initialization function if not already defined
    if (!window.initializePendingCharts) {
        window.initializePendingCharts = function() {
            if (!window.ThemeHelper || !window.chartsToInitialize || !window.chartsToInitialize.length) return;

            // Process all pending charts
            window.chartsToInitialize.forEach(function(chartConfig) {
                const ctx = document.getElementById(chartConfig.id).getContext('2d');
                const chartData = chartConfig.data;

                // Apply theme colors to datasets
                if (chartConfig.useDefaultColors && chartData.data && chartData.data.datasets) {
                    window.ThemeHelper.applyChartDatasetColors(chartData.data.datasets, chartConfig.type, true);
                }

                // Apply theme colors to chart options
                if (chartData.options) {
                    window.ThemeHelper.applyChartOptionsColors(chartData.options);
                }

                // Create the chart
                new Chart(ctx, {
                    type: chartConfig.type,
                    data: chartData.data,
                    options: Object.assign({
                        maintainAspectRatio: false,
                        responsive: true
                    }, chartData.options || {})
                });
            });

            // Clear the processed charts
            window.chartsToInitialize = [];
        };
    }
</script>